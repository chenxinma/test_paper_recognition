<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directory Browser</title>
    <!-- 引入 Element UI 样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
        }
        .app-container {
            display: flex;
            height: calc(100vh - 40px);
        }
        .directory-tree {
            width: 300px;
            border-right: 1px solid #e6e6e6;
            padding-right: 20px;
            overflow-y: auto;
        }
        .file-list {
            width: 400px;
            border-right: 1px solid #e6e6e6;
            padding: 0 20px;
            overflow-y: auto;
        }
        .preview-pane {
            flex: 1;
            padding-left: 20px;
            overflow-y: auto;
        }
        #image-preview {
            max-width: 100%;
            max-height: 80vh;
        }
        #pdf-container {
            width: 100%;
            height: 80vh;
        }
    </style>
</head>
<body>
    <div id="app" class="app-container">
        <div class="directory-tree">
            <h2>目录结构</h2>
            <el-tree 
                :data="treeData" 
                :props="defaultProps" 
                @node-click="handleNodeClick"
                highlight-current
                node-key="path"
                default-expand-all>
            </el-tree>
        </div>
        
        <div class="file-list">
            <h2>文件列表</h2>
            <el-table 
                :data="fileList" 
                style="width: 100%"
                @row-click="handleFileClick">
                <el-table-column prop="name" label="文件名"></el-table-column>
                <el-table-column prop="type" label="类型" width="100"></el-table-column>
            </el-table>
        </div>
        
        <div class="preview-pane">
            <h2>预览</h2>
            <div id="preview-content">
                <p>请选择文件进行预览</p>
            </div>
        </div>
    </div>

    <!-- 引入 Vue 和 Element UI -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
        // 初始化 Vue 实例
        const app = new Vue({
            el: '#app',
            data() {
                return {
                    treeData: [],
                    fileList: [],
                    defaultProps: {
                        children: 'children',
                        label: 'name'
                    },
                    currentPath: ''
                }
            },
            mounted() {
                this.loadRootDirectory();
            },
            methods: {
                loadRootDirectory() {
                    fetch('/api/directory')
                        .then(response => response.json())
                        .then(data => {
                            this.treeData = data.filter(item => item.type === 'directory');
                            this.fileList = data;
                        });
                },
                // Load directory structure
                loadDirectory(path = '', parentElement) {
                    fetch(`/api/directory?path=${encodeURIComponent(path)}`)
                        .then(response => response.json())
                        .then(data => {
                            const ul = document.createElement('ul');
                            data.forEach(item => {
                                const li = document.createElement('li');
                                li.className = 'directory-item';
                                li.textContent = item.name;
                                
                                if (item.type === 'directory') {
                                    const childrenDiv = document.createElement('div');
                                    childrenDiv.className = 'directory-children';
                                    li.addEventListener('click', (e) => {
                                        e.stopPropagation();
                                        if (childrenDiv.style.display === 'block') {
                                            childrenDiv.style.display = 'none';
                                        } else {
                                            childrenDiv.style.display = 'block';
                                            if (!childrenDiv.hasChildNodes()) {
                                                loadDirectory(item.path, childrenDiv);
                                            }
                                        }
                                    });
                                    li.appendChild(childrenDiv);
                                } else {
                                    li.addEventListener('click', () => this.previewFile(item.path));
                                }
                                
                                ul.appendChild(li);
                            });
                            
                            if (parentElement) {
                                parentElement.innerHTML = '';
                                parentElement.appendChild(ul);
                            } else {
                                document.getElementById('root-directory').appendChild(ul);
                            }
                        });
                },
                handleNodeClick(data) {
                    this.currentPath = data.path;
                    fetch(`/api/directory?path=${encodeURIComponent(data.path)}`)
                        .then(response => response.json())
                        .then(data => {
                            this.fileList = data;
                            // 更新treeData
                            const directories = data.filter(item => item.type === 'directory');
                            const findAndUpdateNode = (nodes, path) => {
                                for (const node of nodes) {
                                    if (node.path === path) {
                                        node.children = directories;
                                        console.log('Updated node:', node);
                                        return true;
                                    }
                                    if (node.children && node.children.length > 0) {
                                        if (findAndUpdateNode(node.children, path)) {
                                            return true;
                                        }
                                    }
                                }
                                return false;
                            };
                            
                            findAndUpdateNode(this.treeData, this.currentPath);
                            // 使用Vue.set确保响应式更新
                            this.treeData = [...this.treeData];
                            // this.$forceUpdate(); // 强制Vue重新渲染组件
                        });
                },
                handleFileClick(row) {
                    this.previewFile(row.path);
                },
                previewFile(path) {
                    const previewDiv = document.getElementById('preview-content');
                    previewDiv.innerHTML = '';
                    
                    if (path.match(/\.(png|jpg|jpeg|gif)$/i)) {
                        const img = document.createElement('img');
                        img.id = 'image-preview';
                        img.src = `/api/file?path=${encodeURIComponent(path)}`;
                        previewDiv.appendChild(img);
                    } else if (path.match(/\.pdf$/i)) {
                        const container = document.createElement('div');
                        container.id = 'pdf-container';
                        previewDiv.appendChild(container);
                        
                        fetch(`/api/file?path=${encodeURIComponent(path)}`)
                            .then(response => response.blob())
                            .then(blob => {
                                const fileReader = new FileReader();
                                fileReader.onload = function() {
                                    const typedarray = new Uint8Array(this.result);
                                    pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
                                        pdf.getPage(1).then(function(page) {
                                            const viewport = page.getViewport({ scale: 1.0 });
                                            const canvas = document.createElement('canvas');
                                            const context = canvas.getContext('2d');
                                            canvas.height = viewport.height;
                                            canvas.width = viewport.width;
                                            container.appendChild(canvas);
                                            
                                            page.render({
                                                canvasContext: context,
                                                viewport: viewport
                                            });
                                        });
                                    });
                                };
                                fileReader.readAsArrayBuffer(blob);
                            });
                    } else {
                        previewDiv.innerHTML = '<p>不支持预览此文件类型</p>';
                    }
                },
                handleFileClick(row) {
                    this.previewFile(row.path);
                }
            }
        });
    </script>
</body>
</html>